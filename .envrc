# shellcheck shell=bash
# .envrc for .dotfiles development environment
# Run `direnv allow` to activate
#
# Environment contract:
#   Sets: DOTFILES_DEV=1, HELP_COLOR (default: 1)
#   Modifies PATH: prepends dev/ and bin/
#   Provides: dot command via wrapper script (dev/dot)
#   Assumes: Bash-compatible shell, direnv 2.20+

# Suppress output if requested
: "${DIRENV_QUIET:=0}"

# Add project scripts to PATH (explicit paths only - no security risk)
PATH_add dev     # dot (wrapper), test-smoke, test-bats, ci, check-jsonc, update-gitignore
PATH_add bin     # disk-cleanup

# Development environment flags (respect existing values)
export HELP_COLOR="${HELP_COLOR:-1}"
export DOTFILES_DEV=1

# Watch Makefile for changes (auto-reload on modifications)
watch_file Makefile

# Load local overrides if present (not committed to git)
dotenv_if_exists .env.local
source_env_if_exists .envrc.local

# Check dependencies (only once per shell session for performance)
if [[ -z "${DOTFILES_DEPS_CHECKED:-}" ]] && [[ "${DIRENV_QUIET}" != "1" ]]; then
  _missing=()

  command -v shellcheck >/dev/null 2>&1 || _missing+=("shellcheck")
  command -v bats >/dev/null 2>&1 || _missing+=("bats")
  command -v npx >/dev/null 2>&1 || _missing+=("npx")

  if [[ ${#_missing[@]} -gt 0 ]]; then
    echo "⚠️  Missing: ${_missing[*]} (run 'make deps')" >&2
  fi

  unset _missing
  export DOTFILES_DEPS_CHECKED=1
fi

# Show loaded status (only in interactive shells, unless quiet)
if [[ $- == *i* ]] && [[ "${DIRENV_QUIET}" != "1" ]]; then
  echo "✓ dotfiles dev env loaded (dot, test-smoke, test-bats, ci, disk-cleanup)"
fi
