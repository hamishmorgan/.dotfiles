---
description: "CI/CD workflow structure and performance optimization patterns"
globs: [".github/workflows/**"]
---

# CI/CD

## Workflow Structure

GitHub Actions workflow (`.github/workflows/validate.yml`) uses matrix strategy for efficient testing:

**Job Overview:**

- **lint**: Code quality (shellcheck + markdownlint)
- **smoke-test**: Fast structural validation
- **bats-tests**: All BATS test suites with OS matrix (runs in parallel with lint)
  - `[ubuntu-latest, macos-latest]` - validates test framework cross-platform
  - Runs unit, integration, regression, and contract tests
- **validate-platform**: Full installation with Bash version matrix (runs in parallel with lint)
  - Ubuntu + Bash 5.x (modern Linux)
  - Ubuntu + Bash 3.2 (macOS compatibility)
  - macOS + Bash 3.2 (actual macOS)
- **test-summary**: Aggregates results and provides clear pass/fail summary

**Matrix Benefits:**

- Consolidates 4 separate BATS jobs into 1 (saves 6-8 min per run)
- Validates test framework on both Ubuntu and macOS
- Catches platform-specific issues in tests themselves
- DRY approach reduces duplication

## CI Performance Optimization

Key learnings from CI optimization work (Issue #42, PR #58, Issue #22):

### Caching Strategies

- **Homebrew**: Don't cache. Bottles install faster than cache save/restore overhead.
- **apt packages**: Use user-writable cache (`~/.apt-cache`) to avoid permission issues:

  ```yaml
  - name: Configure apt caching
    run: |
      mkdir -p ~/.apt-cache/archives/partial
      sudo mkdir -p /etc/apt/apt.conf.d
      echo "Dir::Cache::Archives \"$HOME/.apt-cache/archives\";" | sudo tee /etc/apt/apt.conf.d/99user-cache
  ```

- **npm tools**: Use `npx` with version pinning instead of global install:

  ```yaml
  - name: Setup Node.js
    uses: actions/setup-node@v4
    with:
      node-version: "20"
  
  npx --yes markdownlint-cli@0.42.0 "**/*.md"
  ```
  
  Note: npm cache not used - requires package-lock.json which we don't have. npx doesn't benefit from npm cache.

- **Stable cache keys**: Use package names, not file hashes to reduce cache churn.
- **Clean up lock files**: Remove root-owned locks before cache save:

  ```yaml
  - name: Clean up apt cache lock files
    if: always()
    run: rm -rf ~/.apt-cache/archives/lock ~/.apt-cache/archives/partial
  ```

### Performance Insights

- `apt-get update` is the main bottleneck (~8-9s per job)
- Consolidate `apt-get update` and package installations to reduce calls
- Skip installing pre-installed packages (shellcheck is pre-installed on GitHub runners)
- Parallel job execution reduces wall-clock time (bats-tests and validate-platform run in parallel with lint)
- Verbose test output (`-vv`) aids debugging without performance cost
- Use `make -j$(nproc)` for Bash 3.2 builds to maximize parallelism
- Consolidate Homebrew package installations into single command

### Measured Results

Phase 1 optimizations (Issue #42, PR #58) reduced CI time from 8-12 minutes to ~1 minute (92% improvement):

- Linting: 90s → 15s (83% faster)
- Smoke: 30s → 6s (80% faster)
- Ubuntu: 120s → 28s (77% faster)
- Bash 3.2: 120s → 32s (73% faster, cache miss)
- macOS: 180s → 26s (86% faster)

Phase 2 optimizations (Issue #22) consolidated BATS tests:

- **Before**: 4 separate BATS jobs × 2 min setup = 8 min overhead
- **After**: 1 BATS job with OS matrix = 2 min overhead
- **Savings**: 6 min per CI run (~25% additional improvement)
- **Bonus**: BATS tests now validate on macOS (was Ubuntu-only)

Phase 3 optimizations (PR #153) parallelized jobs and optimized setup:

- **Job parallelization**: Removed `needs: lint` from `bats-tests` and `validate-platform`
  - Jobs now run in parallel instead of waiting for lint
  - **Savings**: ~15-30 seconds per run (time to complete lint job)
- **Shellcheck optimization**: Verify pre-installed shellcheck instead of installing
  - **Savings**: ~8-9 seconds per lint job
- **macOS package consolidation**: Install all Homebrew packages in single command
  - **Savings**: ~10-20 seconds per macOS job
- **Bash 3.2 build optimization**: Use `make -j$(nproc)` and `--disable-nls` flag
  - **Savings**: ~30-60 seconds on build (cache miss)
- **apt-get consolidation**: Combine update and install steps
  - **Savings**: ~8-9 seconds per Ubuntu job
- **Node.js setup optimization**: Removed npm cache (not needed for npx usage)
  - npm cache requires package-lock.json which we don't have
  - npx doesn't benefit from npm cache
- **Conditional verification**: Only run verification steps on failure
  - **Savings**: ~2-5 seconds per job

**Total Phase 3 savings**: ~46-78 seconds per run (with cache hits), ~2-3 minutes with cache misses

Phase 4 optimizations (PR #153) enabled BATS parallel execution:

- **BATS parallel execution**: Enable `--jobs 4` flag in CI (was disabled)
  - BATS has built-in parallel support (doesn't require GNU parallel)
  - Modern BATS handles TAP formatter + parallel execution correctly
  - **Savings**: ~50-70% faster BATS test execution (18 test files run in parallel)
- **Simplified parallel detection**: Removed unnecessary GNU parallel check
  - BATS `--jobs` flag works without external tools
  - Cleaner, more maintainable code

**Total Phase 4 savings**: ~30-60 seconds per BATS test run (depending on test suite size)
