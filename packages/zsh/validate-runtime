#!/usr/bin/env bash
# Runtime validation for zsh configuration
# Tests that zsh configs can be sourced without errors

set -e

PACKAGE_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
errors=0

# Test .zshenv (bootstrap file)
if [[ -f "$HOME/.zshenv" ]]; then
    if ! zsh -c "source '$HOME/.zshenv'" >/dev/null 2>&1; then
        echo "Error: .zshenv failed runtime validation" >&2
        zsh -c "source '$HOME/.zshenv'" 2>&1 | head -10 >&2
        ((errors++))
    fi
else
    echo "Error: ~/.zshenv not found" >&2
    ((errors++))
fi

# Test .zshrc (requires .zshenv for ZDOTDIR)
if [[ -f "$HOME/.config/zsh/.zshrc" ]]; then
    if ! zsh -c "source '$HOME/.zshenv' && source '$HOME/.config/zsh/.zshrc'" >/dev/null 2>&1; then
        echo "Error: .config/zsh/.zshrc failed runtime validation" >&2
        zsh -c "source '$HOME/.zshenv'; source '$HOME/.config/zsh/.zshrc'" 2>&1 | head -10 >&2
        ((errors++))
    fi
else
    echo "Error: ~/.config/zsh/.zshrc not found" >&2
    ((errors++))
fi

# Test .zprofile (requires .zshenv for ZDOTDIR)
if [[ -f "$HOME/.config/zsh/.zprofile" ]]; then
    if ! zsh -c "source '$HOME/.zshenv' && source '$HOME/.config/zsh/.zprofile'" >/dev/null 2>&1; then
        echo "Error: .config/zsh/.zprofile failed runtime validation" >&2
        zsh -c "source '$HOME/.zshenv'; source '$HOME/.config/zsh/.zprofile'" 2>&1 | head -10 >&2
        ((errors++))
    fi
else
    echo "Error: ~/.config/zsh/.zprofile not found" >&2
    ((errors++))
fi

if [[ $errors -gt 0 ]]; then
    exit 1
fi

exit 0
