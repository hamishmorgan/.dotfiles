name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  lint:
    name: Code Quality (Shellcheck & Markdownlint)
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: true

    - name: Install linting tools and run linting
      run: |
        sudo apt-get install -y shellcheck
        npm install -g markdownlint-cli
        markdownlint "**/*.md" --ignore node_modules
        shellcheck dot

  smoke-test:
    name: Smoke Tests
    runs-on: ubuntu-latest
    needs: lint

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: true

    - name: Run smoke tests
      run: ./tests/smoke-test.sh

  validate-bash32:
    name: Bash 3.2 Compatibility (Compiled)
    runs-on: ubuntu-latest
    needs: lint

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: true

    - name: Cache Bash 3.2
      uses: actions/cache@v4
      id: cache-bash32
      with:
        path: /tmp/bash-3.2.57-install
        key: bash-3.2.57-${{ runner.os }}-${{ runner.arch }}

    - name: Build Bash 3.2
      if: steps.cache-bash32.outputs.cache-hit != 'true'
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential

        # Download and build bash 3.2.57
        cd /tmp
        curl -L https://ftp.gnu.org/gnu/bash/bash-3.2.57.tar.gz | tar xz
        cd bash-3.2.57
        ./configure --prefix=/tmp/bash-3.2.57-install
        make
        make install

    - name: Install Bash 3.2 and dependencies
      run: |
        # Install bash from cache or fresh build
        sudo cp -r /tmp/bash-3.2.57-install/* /usr/local/

        # Install other dependencies
        sudo apt-get update
        sudo apt-get install -y stow git tmux zsh

        # Verify version
        /usr/local/bin/bash --version

    - name: Create test secrets
      shell: /usr/local/bin/bash {0}
      run: |
        cd ${{ github.workspace }}
        chmod +x tests/lib/*.sh
        ./tests/lib/create-secrets.sh

    - name: Run installation with Bash 3.2
      shell: /usr/local/bin/bash {0}
      run: |
        cd ${{ github.workspace }}
        chmod +x dot
        ./tests/lib/run-installation.sh

    - name: Verify health with Bash 3.2
      shell: /usr/local/bin/bash {0}
      run: |
        cd ${{ github.workspace }}
        ./tests/lib/verify-health.sh true

    - name: Verify bash version used
      shell: /usr/local/bin/bash {0}
      run: |
        echo "Bash version: $BASH_VERSION"
        [[ "$BASH_VERSION" =~ ^3\.2 ]] || (echo "Error: Not running Bash 3.2" && exit 1)

  validate-ubuntu:
    name: Ubuntu Latest (System Bash)
    runs-on: ubuntu-latest
    needs: lint

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: true

    - name: Verify bash version
      run: |
        echo "Bash version: $BASH_VERSION"
        echo "OS: $(lsb_release -d | cut -f2)"
        # Ubuntu latest should have Bash 5.x+
        [[ "${BASH_VERSINFO[0]}" -ge 5 ]] || (echo "Error: Expected Bash 5.x+, got $BASH_VERSION" && exit 1)

    - name: Install dependencies
      run: |
        sudo mv /usr/bin/mandb /usr/bin/mandb.bak 2>/dev/null || true
        sudo ln -s /bin/true /usr/bin/mandb
        sudo apt-get install -y stow git tmux zsh

    - name: Create test secrets
      run: |
        cd ${{ github.workspace }}
        chmod +x tests/lib/*.sh
        ./tests/lib/create-secrets.sh

    - name: Run installation
      run: |
        cd ${{ github.workspace }}
        chmod +x dot
        ./tests/lib/run-installation.sh

    - name: Verify health
      run: |
        cd ${{ github.workspace }}
        ./tests/lib/verify-health.sh true

    - name: Test configurations
      run: |
        zsh -c "source ~/.zshrc && echo 'Zsh configuration loaded successfully'"
        git config --global user.name "Test User"
        git config --global user.email "test@example.com"
        git config --global --list | grep -q "user.name=Test User"
        git config --global --list | grep -q "user.email=test@example.com"

  validate-macos:
    name: macOS Latest (System Bash)
    runs-on: macos-latest
    needs: lint

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: true

    - name: Verify bash version
      run: |
        echo "Bash version: $BASH_VERSION"
        echo "OS: $(sw_vers -productName) $(sw_vers -productVersion)"
        # macOS system bash should be 3.2.x
        [[ "$BASH_VERSION" =~ ^3\.2 ]] || (echo "Error: Expected Bash 3.2.x, got $BASH_VERSION" && exit 1)

    - name: Install dependencies
      run: |
        brew install stow git tmux zsh

    - name: Create test secrets
      run: |
        cd ${{ github.workspace }}
        chmod +x tests/lib/*.sh
        ./tests/lib/create-secrets.sh

    - name: Run installation
      run: |
        cd ${{ github.workspace }}
        chmod +x dot
        # dot script works with macOS default bash 3.2
        ./tests/lib/run-installation.sh

    - name: Verify health
      run: |
        cd ${{ github.workspace }}
        ./tests/lib/verify-health.sh true

    - name: Test configurations
      run: |
        zsh -c "source ~/.zshrc && echo 'Zsh configuration loaded successfully'"
        git config --global user.name "Test User"
        git config --global user.email "test@example.com"
        git config --global --list | grep -q "user.name=Test User"
        git config --global --list | grep -q "user.email=test@example.com"
