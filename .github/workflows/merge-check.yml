name: PR Mergeability Check
permissions:
  contents: read
  pull-requests: read

on:
  pull_request:
    branches: [main]
    types: [opened, synchronize, reopened, ready_for_review]

jobs:
  merge-conflict-check:
    name: Merge Conflict Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}
          fetch-depth: 0

      - name: Fetch base branch
        run: |
          git fetch origin ${{ github.event.pull_request.base.ref }}

      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Check merge conflicts
        run: |
          echo "Checking if PR can merge cleanly into ${{ github.event.pull_request.base.ref }}..."

          # Checkout base branch
          git checkout origin/${{ github.event.pull_request.base.ref }}

          # Try to merge PR branch into base branch (dry run)
          if git merge --no-commit --no-ff ${{ github.event.pull_request.head.sha }}; then
            echo "âœ… No merge conflicts detected"
            git merge --abort 2>/dev/null || true
            exit 0
          else
            echo "âŒ Merge conflicts detected!"
            echo ""
            echo "Conflicting files:"
            git diff --name-only --diff-filter=U
            echo ""
            echo "On your PR branch, rebase on ${{ github.event.pull_request.base.ref }}:"
            echo "  git checkout ${{ github.event.pull_request.head.ref }}"
            echo "  git fetch origin ${{ github.event.pull_request.base.ref }}"
            echo "  git rebase origin/${{ github.event.pull_request.base.ref }}"
            echo "  git push --force-with-lease"
            git merge --abort 2>/dev/null || true
            exit 1
          fi

  mergeability-check:
    name: Mergeability Status
    runs-on: ubuntu-latest
    needs: merge-conflict-check
    steps:
      - name: Check PR mergeability
        uses: actions/github-script@v7
        with:
          script: |
            const core = require('@actions/core');
            
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number,
            });

            console.log('ðŸ“‹ PR Mergeability Status:');
            console.log(`   Draft: ${pr.draft ? 'âŒ Yes (must be ready for review)' : 'âœ… No'}`);
            console.log(`   Mergeable: ${pr.mergeable === true ? 'âœ… Yes' : pr.mergeable === false ? 'âŒ No (conflicts)' : 'â³ Checking...'}`);
            console.log(`   State: ${pr.state}`);
            console.log(`   Base: ${pr.base.ref} â† Head: ${pr.head.ref}`);

            // Check if PR is behind base branch
            const { data: compare } = await github.rest.repos.compareCommits({
              owner: context.repo.owner,
              repo: context.repo.repo,
              base: pr.head.sha,
              head: pr.base.sha,
            });

            const isBehind = compare.behind_by > 0;
            console.log(`   Up to date: ${!isBehind ? 'âœ… Yes' : `âš ï¸  No (${compare.behind_by} commits behind)`}`);

            // Check commit status
            const { data: status } = await github.rest.repos.getCombinedStatusForRef({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: pr.head.sha,
            });

            console.log(`   CI Status: ${status.state === 'success' ? 'âœ… Passing' : status.state === 'failure' ? 'âŒ Failing' : status.state === 'pending' ? 'â³ Pending' : 'âš ï¸  ' + status.state}`);

            // Summary
            const issues = [];
            if (pr.draft) {
              issues.push('PR is in draft status');
            }
            if (pr.mergeable === false) {
              issues.push('Merge conflicts detected');
            }
            if (isBehind) {
              issues.push(`PR is ${compare.behind_by} commit(s) behind base branch`);
            }
            if (status.state === 'failure') {
              issues.push('CI checks are failing');
            }

            if (issues.length === 0) {
              console.log('\nâœ… PR appears mergeable!');
              console.log('   (Final mergeability depends on branch protection rules and approvals)');
            } else {
              console.log('\nâš ï¸  PR mergeability issues:');
              issues.forEach(issue => console.log(`   - ${issue}`));
            }

            // Exit with error if critical issues found
            if (pr.draft || pr.mergeable === false || status.state === 'failure') {
              core.setFailed('PR is not ready to merge');
            }
